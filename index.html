<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Ghost Rooms Pro</title>

<style>
:root {
  --bg: #0a0a0a;
  --accent: #ff4d6d;
  --input-bg: #1a1a1a;
  --text: #ffffff;
  --muted: #888;
  --glass: rgba(255, 255, 255, 0.05);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto;
  background: var(--bg);
  color: var(--text);
  height: 100dvh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* --- HEADER (Instagram Style) --- */
.top-bar {
  padding: 10px 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  border-bottom: 1px solid var(--glass);
  background: rgba(10, 10, 10, 0.8);
  backdrop-filter: blur(10px);
  z-index: 100;
}

.room-name { font-weight: 600; font-size: 16px; margin-bottom: 2px; }
.room-status { font-size: 12px; color: var(--muted); transition: all 0.3s ease; }

/* --- MESSAGES AREA --- */
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding-bottom: 100px; /* Space for input */
}

.msg-wrap {
  max-width: 80%;
  display: flex;
  flex-direction: column;
  position: relative;
  transition: transform 0.2s ease;
}

.me { align-self: flex-end; align-items: flex-end; }
.them { align-self: flex-start; align-items: flex-start; }

.bubble {
  padding: 10px 14px;
  border-radius: 18px;
  font-size: 15px;
  line-height: 1.4;
  position: relative;
}

.me .bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
.them .bubble { background: var(--input-bg); border-bottom-left-radius: 4px; }

.timestamp {
  font-size: 10px;
  color: var(--muted);
  margin-top: 4px;
  height: 0;
  opacity: 0;
  overflow: hidden;
  transition: all 0.2s ease;
}
.timestamp.show { height: 14px; opacity: 1; margin-top: 4px; }

/* Ghost/Shimmer Effect */
.ghost-text {
  background: linear-gradient(90deg, #444 25%, #888 50%, #444 75%);
  background-size: 200% 100%;
  animation: shimmer 2s infinite;
  color: transparent !important;
  background-clip: text;
  -webkit-background-clip: text;
  filter: blur(3px);
}

@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

/* --- INPUT SECTION --- */
.bottom-container {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: var(--bg);
  padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
  border-top: 1px solid var(--glass);
}

.reply-preview {
  display: none;
  padding: 8px;
  background: var(--glass);
  border-left: 3px solid var(--accent);
  margin-bottom: 8px;
  font-size: 12px;
  border-radius: 4px;
}

.input-row { display: flex; align-items: center; gap: 10px; }

.input-field {
  flex: 1;
  background: var(--input-bg);
  border-radius: 24px;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  border: 1px solid var(--glass);
}

.input-field input {
  flex: 1;
  background: none;
  border: none;
  color: white;
  outline: none;
  font-size: 16px;
}

.icon-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 0 5px; color: var(--muted); }
.send-btn {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}

/* --- BOTTOM SHEET --- */
.sheet-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  z-index: 1000;
  align-items: flex-end;
}

.bottom-sheet {
  width: 100%;
  background: #1a1a1a;
  border-radius: 20px 20px 0 0;
  padding: 24px;
  transform: translateY(100%);
  transition: transform 0.3s ease-out;
}

.sheet-overlay.active { display: flex; }
.sheet-overlay.active .bottom-sheet { transform: translateY(0); }

.icon-picker { display: flex; justify-content: space-around; margin: 20px 0; }
.icon-option { width: 60px; height: 60px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: 0.2s; }
.icon-option.selected { border-color: var(--accent); transform: scale(1.1); }

.loader {
  width: 18px; height: 18px;
  border: 2px solid rgba(255,255,255,0.2);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

</style>
</head>
<body>

<div id="homeScreen" style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:40px;">
  <h1 style="letter-spacing:8px; font-weight:200;">GHOSTROOM</h1>
  <p style="color:var(--muted); font-size:14px; margin-bottom:40px;">Messages that never existed.</p>
  <button id="openCreateBtn" class="send-btn" style="width:200px; border-radius:12px; color:white; font-weight:600;">NEW VOID</button>
</div>

<div id="chatScreen" style="display:none; flex:1; flex-direction:column;">
  <div class="top-bar" id="topBar">
    <div class="room-name" id="displayRoomName">Private Room</div>
    <div class="room-status" id="displayRoomInfo">Tap for info</div>
  </div>

  <div id="messages"></div>

  <div class="bottom-container">
    <div id="replyPreview" class="reply-preview">
      <span>Replying to message...</span>
      <span style="float:right; cursor:pointer" onclick="cancelReply()">âœ•</span>
    </div>
    <div class="input-row">
      <button class="icon-btn" onclick="triggerMedia()">ï¼‹</button>
      <div class="input-field">
        <input type="text" id="msgInput" placeholder="Whisper..." autocomplete="off">
        <button id="ghostBtn" class="icon-btn" title="Ghost Mode">ðŸ‘»</button>
      </div>
      <button id="sendBtn" class="send-btn">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
</div>

<div id="createSheet" class="sheet-overlay">
  <div class="bottom-sheet">
    <h3 style="margin-top:0">Create Community</h3>
    <p style="font-size:12px; color:var(--muted)">Expires in 24 hours</p>
    
    <input type="text" id="newRoomName" placeholder="Group Name" style="width:100%; background:var(--glass); border:none; padding:15px; border-radius:10px; color:white; margin-bottom:15px;">
    
    <div class="icon-picker">
      <img src="https://api.dicebear.com/7.x/identicon/svg?seed=1" class="icon-option selected" onclick="selectIcon(this, 1)">
      <img src="https://api.dicebear.com/7.x/identicon/svg?seed=2" class="icon-option" onclick="selectIcon(this, 2)">
      <img src="https://api.dicebear.com/7.x/identicon/svg?seed=3" class="icon-option" onclick="selectIcon(this, 3)">
    </div>

    <button id="confirmCreateBtn" style="width:100%; padding:15px; border-radius:10px; border:none; background:var(--accent); color:white; font-weight:bold;">CREATE</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEUDD0iB4iGFSDoC0a3wCXF8PT098Su3w",
  authDomain: "anonymous-messaging-f93c0.firebaseapp.com",
  projectId: "anonymous-messaging-f93c0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
let currentRoomId = null;
let isGhostMode = false;
let selectedIconSeed = 1;
let replyToId = null;

// Initialize Auth
signInAnonymously(auth).then(user => {
  currentUser = user.user.uid;
});

// UI Elements
const homeScreen = document.getElementById('homeScreen');
const chatScreen = document.getElementById('chatScreen');
const createSheet = document.getElementById('createSheet');
const msgInput = document.getElementById('msgInput');
const messagesDiv = document.getElementById('messages');

// --- ROOM CREATION ---
document.getElementById('openCreateBtn').onclick = () => createSheet.classList.add('active');

window.selectIcon = (el, seed) => {
  document.querySelectorAll('.icon-option').forEach(img => img.classList.remove('selected'));
  el.classList.add('selected');
  selectedIconSeed = seed;
};

document.getElementById('confirmCreateBtn').onclick = async function() {
  const name = document.getElementById('newRoomName').value.trim();
  if(!name) return;

  this.disabled = true;
  this.innerHTML = '<div class="loader" style="margin:auto"></div>';

  try {
    const roomRef = await addDoc(collection(db, "rooms"), {
      name: name,
      creator: currentUser,
      icon: selectedIconSeed,
      createdAt: serverTimestamp(),
      expiresAt: Date.now() + (24 * 60 * 60 * 1000)
    });
    
    currentRoomId = roomRef.id;
    startChat(name);
  } catch (e) {
    console.error(e);
    this.disabled = false;
    this.innerText = "CREATE";
  }
};

// --- CHAT LOGIC ---
function startChat(name) {
  createSheet.classList.remove('active');
  homeScreen.style.display = 'none';
  chatScreen.style.display = 'flex';
  document.getElementById('displayRoomName').innerText = name;

  // Listen for messages
  const q = query(collection(db, "rooms", currentRoomId, "messages"), orderBy("createdAt"));
  onSnapshot(q, (snapshot) => {
    snapshot.docChanges().forEach(change => {
      if (change.type === "added") {
        renderMessage(change.doc.id, change.doc.data());
      }
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

function renderMessage(id, data) {
  const isMe = data.sender === currentUser;
  const wrap = document.createElement('div');
  wrap.className = `msg-wrap ${isMe ? 'me' : 'them'}`;
  wrap.id = `msg-${id}`;

  const bubble = document.createElement('div');
  bubble.className = `bubble ${data.isGhost ? 'ghost-text' : ''}`;
  bubble.innerText = data.text;

  const ts = document.createElement('div');
  ts.className = 'timestamp';
  ts.innerText = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now';

  // Interaction: Tap for timestamp
  bubble.onclick = () => {
    if(data.isGhost && !isMe) {
        bubble.classList.remove('ghost-text');
        setTimeout(() => wrap.style.opacity = '0', 2000);
        setTimeout(() => wrap.remove(), 2300);
    }
    ts.classList.toggle('show');
    setTimeout(() => ts.classList.remove('show'), 2000);
  };

  // Swipe to reply (Simplified for web)
  let startX = 0;
  wrap.ontouchstart = (e) => startX = e.touches[0].clientX;
  wrap.ontouchmove = (e) => {
    let diff = e.touches[0].clientX - startX;
    if (diff > 50) { // Swipe right
      wrap.style.transform = `translateX(40px)`;
      setReply(id, data.text);
    }
  };
  wrap.ontouchend = () => wrap.style.transform = `translateX(0)`;

  wrap.append(bubble, ts);
  messagesDiv.appendChild(wrap);
}

// --- INPUT ACTIONS ---
document.getElementById('ghostBtn').onclick = () => {
  isGhostMode = !isGhostMode;
  document.getElementById('ghostBtn').style.color = isGhostMode ? 'var(--accent)' : 'var(--muted)';
  msgInput.placeholder = isGhostMode ? "One-time whisper..." : "Whisper...";
};

document.getElementById('sendBtn').onclick = async () => {
  const text = msgInput.value.trim();
  if(!text) return;

  msgInput.value = '';
  const payload = {
    text: text,
    sender: currentUser,
    isGhost: isGhostMode,
    replyTo: replyToId,
    createdAt: serverTimestamp()
  };

  await addDoc(collection(db, "rooms", currentRoomId, "messages"), payload);
  
  cancelReply();
  if(isGhostMode) {
    isGhostMode = false;
    document.getElementById('ghostBtn').style.color = 'var(--muted)';
  }
};

function setReply(id, text) {
  replyToId = id;
  const bar = document.getElementById('replyPreview');
  bar.style.display = 'block';
  bar.querySelector('span').innerText = `Replying: ${text.substring(0,20)}...`;
  msgInput.focus();
}

window.cancelReply = () => {
  replyToId = null;
  document.getElementById('replyPreview').style.display = 'none';
};

// --- GESTURES & TOP BAR ---
let lastTap = 0;
document.getElementById('topBar').onclick = (e) => {
  const now = Date.now();
  if (now - lastTap < 300) {
    // Double Tap: Share
    if (navigator.share) {
      navigator.share({ title: 'Join Void', url: window.location.href });
    }
  } else {
    // Single Tap: Status Toggle
    const info = document.getElementById('displayRoomInfo');
    info.innerText = "3 Online â€¢ Expires in 23h";
    setTimeout(() => info.innerText = "Tap for info", 3000);
  }
  lastTap = now;
};

// History access (Long press simulation)
let pressTimer;
document.getElementById('topBar').onmousedown = () => {
    pressTimer = window.setTimeout(() => window.location.href = 'history.html', 1000);
};
document.getElementById('topBar').onmouseup = () => clearTimeout(pressTimer);
document.getElementById('topBar').ontouchstart = () => {
    pressTimer = window.setTimeout(() => window.location.href = 'history.html', 1000);
};
document.getElementById('topBar').ontouchend = () => clearTimeout(pressTimer);

window.triggerMedia = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,video/*';
    input.onchange = () => alert('Media upload would trigger here.');
    input.click();
};

</script>
</body>
</html>
