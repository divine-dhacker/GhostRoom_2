<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Ghost Rooms</title>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  :root {
    --bg: #0a0a0a;
    --accent: #ff4d6d;
    --input-bg: #1a1a1a;
    --text: #ffffff;
    --muted: #666666;
  }

  body {
    margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg); color: var(--text);
    height: 100dvh; overflow: hidden; display: flex; flex-direction: column;
  }

  /* --- Instagram Ticker Header --- */
  .header-zone {
    height: 60px; border-bottom: 1px solid rgba(255,255,255,0.03);
    position: relative; overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  .ticker-item {
    position: absolute; width: 100%; text-align: center; font-size: 13px; color: var(--muted);
    transition: all 0.5s ease-in-out; opacity: 0; transform: translateY(10px);
  }
  .ticker-item.active { opacity: 1; transform: translateY(0); }
  .ticker-item.exit { opacity: 0; transform: translateY(-10px); }

  /* --- Message Feed --- */
  #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; scroll-behavior: smooth; }
  .msg-wrap { margin-bottom: 15px; max-width: 85%; position: relative; transition: transform 0.2s; }
  .bubble { font-size: 16px; line-height: 1.4; cursor: pointer; }
  .me { align-self: flex-end; color: var(--accent); text-align: right; }
  .them { align-self: flex-start; color: white; }

  /* Timestamp (Hidden by default) */
  .timestamp { font-size: 10px; color: var(--muted); margin-top: 4px; display: none; }
  .msg-wrap.show-time .timestamp { display: block; }

  /* --- Ghost Writing (One-Time View) --- */
  .ghost-blur { 
    filter: blur(6px); opacity: 0.5; user-select: none; 
    background: linear-gradient(90deg, #333, #555, #333);
    background-size: 200% 100%; animation: shine 1.5s infinite;
  }
  @keyframes shine { 0% {background-position: -200% 0;} 100% {background-position: 200% 0;} }

  /* --- Input Section (Original Styling) --- */
  .bottom-area { padding: 20px; background: var(--bg); display: flex; align-items: center; gap: 12px; }
  .input-oval {
    flex: 1; background: var(--input-bg); border-radius: 40px; 
    padding: 14px 24px; display: flex; align-items: center;
    border: 1px solid rgba(255,255,255,0.05);
  }
  input { flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none; }
  input::placeholder { color: var(--muted); }

  /* WhatsApp Style Send */
  .circle-send {
    width: 150px; height: 56px; background: #075e54; border-radius: 50%;
    color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none;
  }

  /* --- Bottom Sheet --- */
  .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 1000; }
  .bottom-sheet { 
    position: fixed; bottom: -100%; left: 0; right: 0; background: #121212; 
    border-radius: 25px 25px 0 0; padding: 30px 20px; transition: bottom 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); z-index: 1001; 
  }
  body.sheet-open .bottom-sheet { bottom: 0; }
  body.sheet-open .sheet-overlay { display: block; }

  .loader { width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.1); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body id="mainBody">

<div id="home" style="display: flex; flex-direction: column; height: 100dvh; justify-content: center; align-items: center;">
  <h1 style="font-weight: 200; letter-spacing: 5px;">GHOST</h1>
  <div style="margin-top: 40px; width: 80%;">
    <button id="launchBtn" onclick="handleLaunch('private')" class="circle-send" style="width: 100%; border-radius: 12px; background: var(--input-bg); border: 1px solid rgba(255,255,255,0.05);">PRIVATE VOID</button>
  </div>
</div>

<div id="chat" style="display: none; height: 100dvh; flex-direction: column;">
  <div class="header-zone" id="ticker" onmousedown="startTimer()" onmouseup="handleHeader()" ontouchstart="startTimer()" ontouchend="handleHeader()">
    </div>

  <div id="messages"></div>
  
  <div class="bottom-area" id="inputArea">
    <div class="input-oval">
      <i data-lucide="plus" style="width:20px; color:var(--muted); cursor:pointer" onclick="openSheet('media')"></i>
      <input id="msgInput" placeholder="Whisper into the void..." autocomplete="off">
      <i id="ghostBtn" data-lucide="ghost" style="width:20px; color:var(--muted); cursor:pointer" onclick="toggleGhost()"></i>
    </div>
    <button id="sendBtn" class="circle-send">
      <i data-lucide="send" style="width:22px;"></i>
    </button>
  </div>
</div>

<div class="sheet-overlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="sheetContainer">
  <div style="width:40px; height:4px; background:#333; margin:0 auto 20px; border-radius:10px;"></div>
  <div id="sheetBody"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { apiKey: "AIzaSyCEUDD0iB4iGFSDoC0a3wCXF8PT098Su3w", authDomain: "anonymous-messaging-f93c0.firebaseapp.com", projectId: "anonymous-messaging-f93c0", storageBucket: "anonymous-messaging-f93c0.firebasestorage.app", messagingSenderId: "990716606250", appId: "1:990716606250:web:a82a15347cc5980aa01053" };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentRoom = null, uid = null, isCreator = false, ghostActive = false;

  // --- 1. Ticker Logic (Instagram Style) ---
  const tickerData = ["The Void", "4 Spirits Online", "23h 58m Remaining"];
  let tIdx = 0;
  function rotateTicker() {
    const container = document.getElementById('ticker');
    const old = container.querySelector('.active');
    if(old) { old.classList.replace('active', 'exit'); setTimeout(()=>old.remove(), 500); }
    const next = document.createElement('div');
    next.className = 'ticker-item active';
    next.textContent = tickerData[tIdx];
    container.appendChild(next);
    tIdx = (tIdx + 1) % tickerData.length;
  }
  setInterval(rotateTicker, 3500);

  // --- 2. Gestures ---
  let pressTimer, clickCount = 0;
  window.startTimer = () => pressTimer = setTimeout(() => window.location.href='history.html', 800);
  window.handleHeader = () => {
    clearTimeout(pressTimer);
    clickCount++;
    if(clickCount === 1) {
      setTimeout(() => {
        if(clickCount === 1 && isCreator) openSheet('edit');
        clickCount = 0;
      }, 300);
    } else if(clickCount === 2) {
      clickCount = 0;
      if(navigator.share) navigator.share({ title: 'Join Void', url: window.location.href });
    }
  };

  // --- 3. Keyboard Fix ---
  if(window.visualViewport) {
    window.visualViewport.addEventListener('resize', () => {
      const offset = window.innerHeight - window.visualViewport.height;
      document.getElementById('inputArea').style.transform = `translateY(-${offset}px)`;
    });
  }

  // --- 4. Room Logic ---
  window.handleLaunch = async () => {
    document.getElementById('launchBtn').innerHTML = '<div class="loader"></div>';
    await signInAnonymously(auth);
    uid = auth.currentUser.uid;
    const ref = await addDoc(collection(db, "rooms"), { creator: uid, createdAt: serverTimestamp() });
    isCreator = true;
    window.location.hash = ref.id;
    openChat(ref.id);
  };

  function openChat(id) {
    currentRoom = id;
    document.getElementById('home').style.display = 'none';
    document.getElementById('chat').style.display = 'flex';
    lucide.createIcons();
    rotateTicker();

    onSnapshot(query(collection(db, "rooms", id, "messages"), orderBy("createdAt", "asc")), snap => {
      const msgDiv = document.getElementById('messages');
      msgDiv.innerHTML = '';
      snap.forEach(d => {
        const data = d.data();
        const wrap = document.createElement('div');
        wrap.className = `msg-wrap ${data.sender === uid ? 'me' : 'them'}`;
        wrap.onclick = () => {
          wrap.classList.add('show-time');
          setTimeout(() => wrap.classList.remove('show-time'), 2000);
        };
        
        const textClass = data.isGhost ? 'bubble ghost-blur' : 'bubble';
        wrap.innerHTML = `<div class="${textClass}" onclick="viewOnce(this, ${data.isGhost})">${data.text}</div><div class="timestamp">Just now</div>`;
        msgDiv.appendChild(wrap);
      });
      msgDiv.scrollTop = msgDiv.scrollHeight;
    });
  }

  window.viewOnce = (el, isGhost) => {
    if(!isGhost) return;
    el.classList.remove('ghost-blur');
    setTimeout(() => el.closest('.msg-wrap').style.opacity = '0', 3000);
    setTimeout(() => el.closest('.msg-wrap').remove(), 3500);
  };

  window.toggleGhost = () => {
    ghostActive = !ghostActive;
    document.getElementById('ghostBtn').style.color = ghostActive ? 'var(--accent)' : 'var(--muted)';
  };

  document.getElementById('sendBtn').onclick = async () => {
    const text = document.getElementById('msgInput').value.trim();
    if(!text) return;
    document.getElementById('msgInput').value = '';
    await addDoc(collection(db, "rooms", currentRoom, "messages"), {
      text, sender: uid, isGhost: ghostActive, createdAt: serverTimestamp()
    });
    ghostActive = false;
    document.getElementById('ghostBtn').style.color = 'var(--muted)';
  };

  window.openSheet = (mode) => {
    const body = document.getElementById('sheetBody');
    if(mode === 'edit') {
      body.innerHTML = `<h2 style="font-weight:200">Edit Void</h2><input placeholder="Community Name" style="width:100%; padding:15px; background:#1a1a1a; border:none; border-radius:10px; color:white;"><button class="circle-send" style="width:100%; margin-top:20px; border-radius:10px;">Update</button>`;
    } else {
      body.innerHTML = `<h2 style="font-weight:200">Shared Media</h2><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><div style="background:#1a1a1a; aspect-ratio:1; border-radius:10px;"></div><div style="background:#1a1a1a; aspect-ratio:1; border-radius:10px;"></div></div>`;
    }
    document.getElementById('mainBody').classList.add('sheet-open');
  };
  window.closeSheet = () => document.getElementById('mainBody').classList.remove('sheet-open');

  if(window.location.hash) openChat(window.location.hash.slice(1));
</script>
</body>
</html>
